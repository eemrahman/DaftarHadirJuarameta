<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyib14Bqwor_C8obsmnTshVB2lOE6ttM6MlL5SteMXNiX-l5Zt30FTpzNqZWt8LZK2B9Q/exec"; 
    let latitude = null, longitude = null;
    const allowedSSID = ["aiko"]; // Ganti dengan SSID yang diizinkan

    function checkWiFi() {
        if (navigator.connection) {
            if (navigator.connection.type !== "wifi") {
                alert("‚ùå Anda harus terhubung ke WiFi lokasi untuk mengisi daftar hadir!");
                return false;
            }
        } else {
            alert("‚ö†Ô∏è Tidak dapat mendeteksi jaringan. Coba gunakan browser terbaru.");
            return false;
        }
        return true;
    }

    function requestLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    document.getElementById("lokasi-status").innerText = `üìç Lokasi: ${latitude}, ${longitude}`;
                    document.getElementById("lokasi-status").classList.add("success");
                },
                (error) => {
                    alert("Gagal mendapatkan lokasi: " + error.message);
                    document.getElementById("lokasi-status").innerText = "‚ö†Ô∏è Lokasi tidak tersedia";
                    document.getElementById("lokasi-status").classList.add("error");
                }
            );
        } else {
            alert("Perangkat tidak mendukung GPS.");
        }
    }

    function submitForm() {
        if (!checkWiFi()) return;

        const nama = document.getElementById("nama").value.trim();
        const status = document.getElementById("status").value;
        const regexNama = /^[A-Za-z\s]+$/;

        if (!nama.match(regexNama)) {
            alert("‚ùå Nama hanya boleh mengandung huruf dan spasi!");
            return;
        }
        if (!nama || !status) {
            alert("Harap isi semua data!");
            return;
        }
        if (latitude === null || longitude === null) {
            alert("Harap izinkan lokasi terlebih dahulu!");
            return;
        }

        fetch(scriptURL, {
            method: "POST",
            body: new URLSearchParams({ nama, status, latitude, longitude }),
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
        })
        .then(response => response.text())
        .then(() => {
            alert("‚úÖ Data berhasil dikirim!");
            document.getElementById("nama").value = "";
            document.getElementById("status").value = "";
            loadData();
        })
        .catch(error => console.error("Error:", error));
    }

    function loadData() {
        fetch(scriptURL)
            .then(response => response.json())
            .then(data => {
                let tableContent = `<tr>
                    <th>Waktu</th>
                    <th>Nama</th>
                    <th>Status</th>
                    <th>Lokasi</th>
                    <th>Aksi</th>
                </tr>`;

                let today = new Date().toISOString().split("T")[0];

                data.slice(1).forEach(row => {
                    let timestamp = new Date(row[0]);
                    let rowDate = timestamp.toISOString().split("T")[0];

                    let options = { timeZone: "Asia/Jakarta", hour12: false, 
                        year: "numeric", month: "2-digit", day: "2-digit", 
                        hour: "2-digit", minute: "2-digit", second: "2-digit" 
                    };
                    let localTime = new Intl.DateTimeFormat("id-ID", options).format(timestamp);

                    if (rowDate === today) {
                        tableContent += `<tr>
                            <td>${localTime}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td>üìç ${row[3]}, ${row[4]}</td>
                            <td><button class="btn-map" onclick="openMap(${row[3]}, ${row[4]})">Lihat Lokasi</button></td>
                        </tr>`;
                    }
                });

                document.getElementById("dataTable").innerHTML = tableContent;
            })
            .catch(error => console.error("Error:", error));
    }

    setInterval(loadData, 5000);

    function openMap(lat, lon) {
        window.open(`https://www.google.com/maps?q=${lat},${lon}`, "_blank");
    }

    window.onload = loadData;

    document.getElementById("nama").addEventListener("input", function(event) {
        this.value = this.value.replace(/[^A-Za-z\s]/g, "");
    });
</script>
